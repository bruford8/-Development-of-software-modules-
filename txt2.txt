import sys
import os
import shutil
from PyQt6.QtCore import *
from PyQt6.QtWidgets import *
from PyQt6.QtGui import *


class SimpleTranslator(QObject):
    languageChanged = pyqtSignal()

    def __init__(self):
        super().__init__()
        self.current_language = "en"
        self.translations = {}
        self.load_language("en")

    def load_language(self, lang_code):
        """Загружает переводы из TXT файла"""
        self.translations.clear()
        file_path = f"languages/{lang_code}.txt"

        print(f"Загружаем язык: {lang_code}")

        try:
            with open(file_path, 'r', encoding='utf-8') as file:
                for line in file:
                    line = line.strip()
                    if not line or line.startswith('#'):
                        continue
                    if '=' in line:
                        key, value = line.split('=', 1)
                        key = key.strip()
                        value = value.strip()
                        self.translations[key] = value

            self.current_language = lang_code
            print(f"Язык успешно изменен на: {lang_code}")
            self.languageChanged.emit()
            return True

        except Exception as e:
            print(f"Ошибка загрузки языка: {e}")
            return False

    def tr(self, key):
        """Возвращает перевод по ключу"""
        return self.translations.get(key, key)


class BaseWindow(QMainWindow):
    """Базовый класс для всех окон с поддержкой перевода"""

    def __init__(self, translator):
        super().__init__()
        self.translator = translator
        self.translator.languageChanged.connect(self.retranslate_ui)

    def retranslate_ui(self):
        """Должен быть переопределен в дочерних классах"""
        pass

    def apply_theme(self, theme):
        """Общая функция применения темы"""
        if theme == "dark":
            dark_palette = QPalette()
            dark_palette.setColor(QPalette.ColorRole.Window, QColor(53, 53, 53))
            dark_palette.setColor(QPalette.ColorRole.WindowText, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.Base, QColor(25, 25, 25))
            dark_palette.setColor(QPalette.ColorRole.AlternateBase, QColor(53, 53, 53))
            dark_palette.setColor(QPalette.ColorRole.ToolTipBase, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.ToolTipText, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.Text, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.Button, QColor(53, 53, 53))
            dark_palette.setColor(QPalette.ColorRole.ButtonText, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.BrightText, Qt.GlobalColor.red)
            dark_palette.setColor(QPalette.ColorRole.Link, QColor(42, 130, 218))
            dark_palette.setColor(QPalette.ColorRole.Highlight, QColor(42, 130, 218))
            dark_palette.setColor(QPalette.ColorRole.HighlightedText, Qt.GlobalColor.black)
            QApplication.instance().setPalette(dark_palette)
        else:
            QApplication.instance().setPalette(QApplication.style().standardPalette())


class Autorization(BaseWindow):
    def __init__(self, translator):
        super().__init__(translator)

        self.setFixedSize(1920, 1080)
        self.settings = QSettings("ANK Software")
        saved_theme = self.settings.value("theme", "light")
        self.apply_theme(saved_theme)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        main_layout = QVBoxLayout(central_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        self.label = QLabel()
        self.label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        font = QFont()
        font.setPointSize(15)
        self.label.setFont(font)
        main_layout.addWidget(self.label)

        self.autorization1 = QLineEdit("управляющий")
        self.autorization2 = QLineEdit("09112001")
        self.autorization2.setFixedSize(350, 22)
        self.autorization1.setFixedSize(350, 22)
        self.autorization2.setEchoMode(QLineEdit.EchoMode.Password)
        main_layout.addWidget(self.autorization1)
        main_layout.addWidget(self.autorization2)

        self.button_auth = QPushButton()
        self.button_auth.clicked.connect(self.check_credentials)
        main_layout.addWidget(self.button_auth)

        self.retranslate_ui()

    def retranslate_ui(self):
        tr = self.translator.tr
        self.setWindowTitle(tr("app_title"))
        self.label.setText(tr("autorization"))
        self.autorization1.setPlaceholderText(tr("login"))
        self.autorization2.setPlaceholderText(tr("password"))
        self.button_auth.setText(tr("login_button"))

    def check_credentials(self):
        username = self.autorization1.text()
        password = self.autorization2.text()

        if username == "управляющий" and password == "09112001":
            self.open_main_window()
        else:
            QMessageBox.warning(self,
                                self.translator.tr("error"),
                                self.translator.tr("wrong_credentials"))

    def open_main_window(self):
        self.main_window = MainWindow(self.translator)
        self.main_window.show()
        self.close()


class MainWindow(BaseWindow):
    def __init__(self, translator):
        super().__init__(translator)

        self.setFixedSize(1920, 1080)
        self.settings = QSettings("ANK Software")
        saved_theme = self.settings.value("theme", "light")
        self.apply_theme(saved_theme)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        main_layout = QHBoxLayout(central_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)

        self.menu_bar = self.menuBar()

        self.create_menus()
        self.retranslate_ui()

    def create_menus(self):
        # Меню Manager
        self.manager_menu = QMenu(self)
        self.shift_report_action = QAction(self)
        self.shift_report_action.triggered.connect(self.open_shift_report_window)
        self.manager_menu.addAction(self.shift_report_action)

        self.exit_action = QAction(self)
        self.exit_action.triggered.connect(self.open_autorization_window)
        self.manager_menu.addAction(self.exit_action)

        # Меню Tools
        self.tools_menu = QMenu(self)
        self.settings_action = QAction(self)
        self.settings_action.triggered.connect(self.open_settings_window)
        self.tools_menu.addAction(self.settings_action)

        # Меню Help
        self.help_menu = QMenu(self)
        self.user_guide_action = QAction(self)
        self.about_action = QAction(self)
        self.support_action = QAction(self)
        self.help_menu.addAction(self.user_guide_action)
        self.help_menu.addAction(self.about_action)
        self.help_menu.addAction(self.support_action)

        # Добавляем меню в менюбар
        self.menu_bar.addMenu(self.manager_menu)
        self.menu_bar.addMenu(self.tools_menu)
        self.menu_bar.addMenu(self.help_menu)

    def retranslate_ui(self):
        tr = self.translator.tr
        self.setWindowTitle(tr("app_title"))

        # Обновляем меню
        self.manager_menu.setTitle(tr("manager"))
        self.shift_report_action.setText(tr("shift_report"))
        self.exit_action.setText(tr("exit"))

        self.tools_menu.setTitle(tr("tools"))
        self.settings_action.setText(tr("settings"))

        self.help_menu.setTitle(tr("help"))
        self.user_guide_action.setText(tr("user_guide"))
        self.about_action.setText(tr("about"))
        self.support_action.setText(tr("support"))

    def open_autorization_window(self):
        self.autorization = Autorization(self.translator)
        self.autorization.show()
        self.close()

    def open_settings_window(self):
        self.settings_window = Settings(self.translator)
        self.settings_window.show()
        self.close()

    def open_shift_report_window(self):
        self.shift_report = ShiftReportWindow(self.translator)
        self.shift_report.show()
        self.close()


class ShiftReportWindow(BaseWindow):
    def __init__(self, translator):
        super().__init__(translator)

        self.setFixedSize(1920, 1080)
        self.settings = QSettings("ANK Software")
        saved_theme = self.settings.value("theme", "light")
        self.apply_theme(saved_theme)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        # Основной layout с выравниванием по центру
        main_layout = QVBoxLayout(central_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        # Меню
        self.menu_bar = self.menuBar()
        self.manager_menu = QMenu(self)
        self.back_action = QAction(self)
        self.back_action.triggered.connect(self.open_main_window)
        self.manager_menu.addAction(self.back_action)
        self.menu_bar.addMenu(self.manager_menu)

        # Заголовок
        self.title_label = QLabel()
        self.title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        font = QFont()
        font.setPointSize(24)
        font.setBold(True)
        self.title_label.setFont(font)
        main_layout.addWidget(self.title_label)

        # Добавляем отступ
        main_layout.addSpacing(50)

        # Группа для полей ввода по центру
        self.input_group = QGroupBox()
        self.input_group.setFixedSize(500, 300)
        input_layout = QVBoxLayout()
        input_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        # Поле для наличных
        cash_layout = QHBoxLayout()
        self.cash_label = QLabel()
        self.cash_label.setFixedWidth(120)
        self.cash_label.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.cash_input = QLineEdit()
        self.cash_input.setFixedSize(200, 30)
        cash_layout.addWidget(self.cash_label)
        cash_layout.addWidget(self.cash_input)
        cash_layout.addStretch()
        input_layout.addLayout(cash_layout)

        # Добавляем отступ между полями
        input_layout.addSpacing(20)

        # Поле для карты
        card_layout = QHBoxLayout()
        self.card_label = QLabel()
        self.card_label.setFixedWidth(120)
        self.card_label.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.card_input = QLineEdit()
        self.card_input.setFixedSize(200, 30)
        card_layout.addWidget(self.card_label)
        card_layout.addWidget(self.card_input)
        card_layout.addStretch()
        input_layout.addLayout(card_layout)

        # Добавляем отступ между полями
        input_layout.addSpacing(20)

        # Поле для остатка
        balance_layout = QHBoxLayout()
        self.balance_label = QLabel()
        self.balance_label.setFixedWidth(120)
        self.balance_label.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.balance_input = QLineEdit()
        self.balance_input.setFixedSize(200, 30)
        balance_layout.addWidget(self.balance_label)
        balance_layout.addWidget(self.balance_input)
        balance_layout.addStretch()
        input_layout.addLayout(balance_layout)

        # Добавляем отступ перед кнопкой
        input_layout.addSpacing(40)

        # Кнопка подтверждения по центру
        button_layout = QHBoxLayout()
        button_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.confirm_button = QPushButton()
        self.confirm_button.setFixedSize(150, 40)
        self.confirm_button.clicked.connect(self.confirm_shift_end)
        button_layout.addWidget(self.confirm_button)
        input_layout.addLayout(button_layout)

        self.input_group.setLayout(input_layout)

        # Центрируем группу в основном layout
        group_layout = QHBoxLayout()
        group_layout.addStretch()
        group_layout.addWidget(self.input_group)
        group_layout.addStretch()

        main_layout.addLayout(group_layout)

        self.retranslate_ui()

    def retranslate_ui(self):
        tr = self.translator.tr
        self.setWindowTitle(f"{tr('app_title')} - {tr('shift_report')}")
        self.manager_menu.setTitle(tr("manager"))
        self.back_action.setText(tr("back"))
        self.title_label.setText(tr("shift_end_title"))
        self.input_group.setTitle(tr("enter_amounts"))
        self.cash_label.setText(tr("cash"))
        self.cash_input.setPlaceholderText(tr("enter_amounts"))
        self.card_label.setText(tr("card"))
        self.card_input.setPlaceholderText(tr("enter_amounts"))
        self.balance_label.setText(tr("balance"))
        self.balance_input.setPlaceholderText(tr("enter_amounts"))
        self.confirm_button.setText(tr("confirm"))

    def confirm_shift_end(self):
        cash = self.cash_input.text()
        card = self.card_input.text()
        balance = self.balance_input.text()
        tr = self.translator.tr

        # Проверка, что все поля заполнены
        if not cash or not card or not balance:
            QMessageBox.warning(self, tr("error"), tr("please_fill_all"))
            return

        # Проверка, что введены числа
        try:
            cash_value = float(cash)
            card_value = float(card)
            balance_value = float(balance)
        except ValueError:
            QMessageBox.warning(self, tr("error"), tr("enter_valid_numbers"))
            return

        # Проверка на положительные значения
        if cash_value <= 0 or card_value <= 0 or balance_value <= 0:
            QMessageBox.warning(self, tr("error"), tr("values_positive"))
            return

        # Здесь можно добавить логику обработки данных
        QMessageBox.information(self, tr("shift_completed"),
                                f"{tr('shift_completed')}!\n"
                                f"{tr('cash_amount')}: {cash_value:.2f}\n"
                                f"{tr('card_amount')}: {card_value:.2f}\n"
                                f"{tr('balance_amount')}: {balance_value:.2f}")

    def open_main_window(self):
        self.main_window = MainWindow(self.translator)
        self.main_window.show()
        self.close()


class Settings(BaseWindow):
    def __init__(self, translator):
        super().__init__(translator)

        self.setFixedSize(1920, 1080)
        self.settings = QSettings("ANK Software")
        self.current_theme = self.settings.value("theme", "light")
        self.apply_theme(self.current_theme)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        main_layout = QVBoxLayout(central_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setSpacing(20)

        self.menu_bar = self.menuBar()
        self.tools_menu = QMenu(self)
        self.back_action = QAction(self)
        self.back_action.triggered.connect(self.open_main_window)
        self.tools_menu.addAction(self.back_action)
        self.menu_bar.addMenu(self.tools_menu)

        self.title_label = QLabel()
        self.title_label.setAlignment(Qt.AlignmentFlag.AlignLeft)
        font = QFont()
        font.setPointSize(18)
        self.title_label.setFont(font)
        main_layout.addWidget(self.title_label)

        # Группа для выбора языка
        self.language_group = QGroupBox()
        self.language_group.setFixedSize(300, 100)
        language_layout = QVBoxLayout()

        self.language_label = QLabel()
        self.language_combo = QComboBox()
        self.language_combo.addItem("English", "en")
        self.language_combo.addItem("Русский", "ru")

        # Устанавливаем текущий язык
        current_index = self.language_combo.findData(self.translator.current_language)
        if current_index >= 0:
            self.language_combo.setCurrentIndex(current_index)

        self.language_combo.currentIndexChanged.connect(self.change_language)

        language_layout.addWidget(self.language_label)
        language_layout.addWidget(self.language_combo)
        self.language_group.setLayout(language_layout)
        main_layout.addWidget(self.language_group)

        # Группа для темы
        self.theme_group = QGroupBox()
        self.theme_group.setFixedSize(300, 100)
        theme_layout = QVBoxLayout()

        self.light_theme_btn = QPushButton()
        self.dark_theme_btn = QPushButton()

        self.light_theme_btn.clicked.connect(lambda: self.change_theme("light"))
        self.dark_theme_btn.clicked.connect(lambda: self.change_theme("dark"))

        theme_layout.addWidget(self.light_theme_btn)
        self.light_theme_btn.setFixedSize(280, 30)
        theme_layout.addWidget(self.dark_theme_btn)
        self.dark_theme_btn.setFixedSize(280, 30)
        self.theme_group.setLayout(theme_layout)
        main_layout.addWidget(self.theme_group)

        self.retranslate_ui()

    def change_language(self, index):
        """Смена языка"""
        if index >= 0:
            lang_code = self.language_combo.itemData(index)
            if lang_code and lang_code != self.translator.current_language:
                print(f"Пытаемся сменить язык на: {lang_code}")
                success = self.translator.load_language(lang_code)
                if success:
                    print("Язык успешно изменен!")

    def change_theme(self, theme):
        self.current_theme = theme
        self.settings.setValue("theme", theme)
        self.apply_theme(theme)

    def retranslate_ui(self):
        tr = self.translator.tr
        self.setWindowTitle(tr("app_title"))
        self.tools_menu.setTitle(tr("tools"))
        self.back_action.setText(tr("back"))
        self.title_label.setText(tr("settings"))
        self.theme_group.setTitle(tr("theme"))
        self.language_group.setTitle(tr("language"))
        self.light_theme_btn.setText(tr("light_theme"))
        self.dark_theme_btn.setText(tr("dark_theme"))
        self.language_label.setText(tr("language") + ":")

    def open_main_window(self):
        self.main_window = MainWindow(self.translator)
        self.main_window.show()
        self.close()


# Функция для создания языковых файлов
def create_language_files():
    """Создает или перезаписывает языковые файлы"""
    if os.path.exists('languages'):
        shutil.rmtree('languages')
    os.makedirs('languages')

    languages = {
        'en.txt': """app_title = ANK Software
autorization = Autorization
login = Login
password = Password
login_button = Login
error = Error
wrong_credentials = Wrong login, or password!
manager = Manager
shift_report = Shift report
exit = Exit
tools = Tools
settings = Settings
help = Help
user_guide = User Guide
about = About
support = Support
back = Back
shift_end_title = End of Shift
enter_amounts = Enter amounts
cash = Cash:
card = Card:
balance = Balance:
confirm = Confirm
please_fill_all = Please fill all fields!
enter_valid_numbers = Please enter valid numeric values!
values_positive = Values must be positive and greater than zero!
shift_completed = Shift completed!
cash_amount = Cash
card_amount = Card
balance_amount = Balance
light_theme = Light theme
dark_theme = Dark theme
language = Language
theme = Theme""",

        'ru.txt': """app_title = ANK Software
autorization = Авторизация
login = Логин
password = Пароль
login_button = Войти
error = Ошибка
wrong_credentials = Неправильный логин или пароль!
manager = Менеджер
shift_report = Отчет о смене
exit = Выход
tools = Инструменты
settings = Настройки
help = Помощь
user_guide = Руководство пользователя
about = О программе
support = Поддержка
back = Назад
shift_end_title = Конец смены
enter_amounts = Введите суммы
cash = Наличные:
card = Карта:
balance = Остаток:
confirm = Подтвердить
please_fill_all = Пожалуйста, заполните все поля!
enter_valid_numbers = Пожалуйста, введите корректные числовые значения!
values_positive = Значения должны быть положительными и больше нуля!
shift_completed = Смена завершена!
cash_amount = Наличные
card_amount = Карта
balance_amount = Остаток
light_theme = Светлая тема
dark_theme = Темная тема
language = Язык
theme = Тема"""
    }

    for filename, content in languages.items():
        with open(f'languages/{filename}', 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"Создан файл: languages/{filename}")


if __name__ == "__main__":
    # Создаем языковые файлы
    create_language_files()

    app = QApplication(sys.argv)
    app.setStyle('Fusion')

    translator = SimpleTranslator()
    window = Autorization(translator)
    window.show()
    window.showMaximized()

    app.exec()
