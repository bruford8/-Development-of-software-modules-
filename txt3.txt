import sys
import os
import shutil
from PyQt6.QtCore import *
from PyQt6.QtWidgets import *
from PyQt6.QtGui import *


class SimpleTranslator(QObject):
    languageChanged = pyqtSignal()

    def __init__(self):
        super().__init__()
        self.current_language = "en"
        self.translations = {}
        self.load_language("en")

    def load_language(self, lang_code):
        """Загружает переводы из TXT файла"""
        self.translations.clear()
        file_path = f"languages/{lang_code}.txt"

        try:
            with open(file_path, 'r', encoding='utf-8') as file:
                for line in file:
                    line = line.strip()
                    if not line or line.startswith('#'):
                        continue
                    if '=' in line:
                        key, value = line.split('=', 1)
                        key = key.strip()
                        value = value.strip()
                        self.translations[key] = value

            self.current_language = lang_code
            self.languageChanged.emit()
            return True

        except Exception as e:
            print(f"Ошибка загрузки языка: {e}")
            return False

    def tr(self, key):
        """Возвращает перевод по ключу"""
        return self.translations.get(key, key)


class BaseWindow(QMainWindow):
    """Базовый класс для всех окон с поддержкой перевода"""

    def __init__(self, translator=None):
        super().__init__()
        self.translator = translator
        if translator:
            self.translator.languageChanged.connect(self.retranslate_ui)

    def retranslate_ui(self):
        """Должен быть переопределен в дочерних классах"""
        pass

    def apply_theme_and_style(self, theme, style):
        """Общая функция применения темы и стиля"""
        app = QApplication.instance()
        
        if style:
            app.setStyle(style)

        if theme == "dark":
            dark_palette = QPalette()
            dark_palette.setColor(QPalette.ColorRole.Window, QColor(53, 53, 53))
            dark_palette.setColor(QPalette.ColorRole.WindowText, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.Base, QColor(25, 25, 25))
            dark_palette.setColor(QPalette.ColorRole.AlternateBase, QColor(53, 53, 53))
            dark_palette.setColor(QPalette.ColorRole.ToolTipBase, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.ToolTipText, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.Text, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.Button, QColor(53, 53, 53))
            dark_palette.setColor(QPalette.ColorRole.ButtonText, Qt.GlobalColor.white)
            dark_palette.setColor(QPalette.ColorRole.BrightText, Qt.GlobalColor.red)
            dark_palette.setColor(QPalette.ColorRole.Link, QColor(42, 130, 218))
            dark_palette.setColor(QPalette.ColorRole.Highlight, QColor(42, 130, 218))
            dark_palette.setColor(QPalette.ColorRole.HighlightedText, Qt.GlobalColor.black)
            app.setPalette(dark_palette)
        else:
            app.setPalette(app.style().standardPalette())

    def show_maximized(self):
        self.show()
        self.showMaximized()


class Autorization(BaseWindow):
    def __init__(self, translator=None):
        super().__init__(translator)
        self.translator = translator
        
        self.setWindowTitle("ANK Software")
        self.settings = QSettings("ANK Software", "ThemeSettings")
        saved_theme = self.settings.value("theme", "light")
        saved_style = self.settings.value("style", "Fusion")
        self.apply_theme_and_style(saved_theme, saved_style)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        main_layout = QVBoxLayout(central_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        self.label = QLabel("Autorization" if not translator else "")
        self.label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        font = QFont()
        font.setPointSize(15)
        self.label.setFont(font)
        main_layout.addWidget(self.label)

        self.autorization1 = QLineEdit("управляющий")
        self.autorization2 = QLineEdit("09112001")
        self.autorization2.setFixedSize(350, 22)
        self.autorization1.setFixedSize(350, 22)
        self.autorization2.setEchoMode(QLineEdit.EchoMode.Password)
        self.autorization1.setPlaceholderText("Login" if not translator else "")
        self.autorization2.setPlaceholderText("Password" if not translator else "")
        main_layout.addWidget(self.autorization1)
        main_layout.addWidget(self.autorization2)

        self.button_auth = QPushButton("Login" if not translator else "")
        self.button_auth.clicked.connect(self.check_credentials)
        main_layout.addWidget(self.button_auth)

        if translator:
            self.retranslate_ui()

    def retranslate_ui(self):
        if not self.translator:
            return
        tr = self.translator.tr
        self.setWindowTitle(tr("app_title"))
        self.label.setText(tr("autorization"))
        self.autorization1.setPlaceholderText(tr("login"))
        self.autorization2.setPlaceholderText(tr("password"))
        self.button_auth.setText(tr("login_button"))

    def check_credentials(self):
        username = self.autorization1.text()
        password = self.autorization2.text()

        if username == "управляющий" and password == "09112001":
            self.open_main_window()
        else:
            error_msg = "Wrong login, or password!"
            if self.translator:
                error_msg = self.translator.tr("wrong_credentials")
            QMessageBox.warning(self, "Error", error_msg)

    def open_main_window(self):
        self.main_window = MainWindow(self.translator)
        self.main_window.show_maximized()
        self.close()


class MainWindow(BaseWindow):
    def __init__(self, translator=None):
        super().__init__(translator)
        self.translator = translator
        
        self.setWindowTitle("ANK Software")
        self.settings = QSettings("ANK Software")
        saved_theme = self.settings.value("theme", "light")
        saved_style = self.settings.value("style", "Fusion")
        self.apply_theme_and_style(saved_theme, saved_style)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        main_layout = QHBoxLayout(central_widget)
        
        # Левая панель с кнопками
        left_widget = QWidget()
        left_layout = QVBoxLayout(left_widget)
        left_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        
        # Кнопки для левой панели
        buttons_data = [
            ("Computers", 200, 40),
            ("Sales", 200, 40),
            ("Users", 200, 40),
            ("Manage", 200, 40),
            ("Deployment", 200, 40),
            ("Monitoring", 200, 40),
            ("Reports", 200, 40),
            ("Log", 200, 40)
        ]
        
        self.buttons = []
        for text, width, height in buttons_data:
            btn = QPushButton(text)
            btn.setFixedSize(width, height)
            left_layout.addWidget(btn)
            self.buttons.append(btn)
        
        left_layout.addStretch()
        
        # Основная область
        main_area = QWidget()
        main_area_layout = QVBoxLayout(main_area)
        
        main_layout.addWidget(left_widget)
        main_layout.addWidget(main_area)

        # Создаем меню
        self.create_menus()

        if translator:
            self.retranslate_ui()

    def create_menus(self):
        menu_bar = self.menuBar()

        # Меню Manager
        self.manager_menu = menu_bar.addMenu("Manager" if not self.translator else "")
        self.shift_report_action = QAction("Shift report" if not self.translator else "", self)
        self.shift_report_action.triggered.connect(self.open_shift_report_window)
        self.manager_menu.addAction(self.shift_report_action)
        
        self.exit_action = QAction("Exit" if not self.translator else "", self)
        self.exit_action.triggered.connect(self.open_autorization_window)
        self.manager_menu.addAction(self.exit_action)

        # Меню Tools
        self.tools_menu = menu_bar.addMenu("Tools" if not self.translator else "")
        self.settings_action = QAction("Settings" if not self.translator else "", self)
        self.settings_action.triggered.connect(self.open_settings_window)
        self.tools_menu.addAction(self.settings_action)

        # Меню Help
        self.help_menu = menu_bar.addMenu("Help" if not self.translator else "")
        self.user_guide_action = QAction("User Guide" if not self.translator else "", self)
        self.about_action = QAction("About" if not self.translator else "", self)
        self.support_action = QAction("Support" if not self.translator else "", self)
        self.help_menu.addAction(self.user_guide_action)
        self.help_menu.addAction(self.about_action)
        self.help_menu.addAction(self.support_action)

    def retranslate_ui(self):
        if not self.translator:
            return
        tr = self.translator.tr
        self.setWindowTitle(tr("app_title"))
        
        # Обновляем меню
        self.manager_menu.setTitle(tr("manager"))
        self.shift_report_action.setText(tr("shift_report"))
        self.exit_action.setText(tr("exit"))
        self.tools_menu.setTitle(tr("tools"))
        self.settings_action.setText(tr("settings"))
        self.help_menu.setTitle(tr("help"))
        self.user_guide_action.setText(tr("user_guide"))
        self.about_action.setText(tr("about"))
        self.support_action.setText(tr("support"))

    def open_autorization_window(self):
        self.autorization = Autorization(self.translator)
        self.autorization.show_maximized()
        self.close()

    def open_settings_window(self):
        self.settings_window = Settings(self.translator)
        self.settings_window.show_maximized()
        self.close()

    def open_shift_report_window(self):
        self.shift_report = ShiftReportWindow(self.translator)
        self.shift_report.show_maximized()
        self.close()


class ShiftReportWindow(BaseWindow):
    def __init__(self, translator=None):
        super().__init__(translator)
        self.translator = translator
        
        self.setWindowTitle("ANK Software - Shift Report")
        self.settings = QSettings("ANK Software")
        saved_theme = self.settings.value("theme", "light")
        saved_style = self.settings.value("style", "Fusion")
        self.apply_theme_and_style(saved_theme, saved_style)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        # Основной layout с выравниванием по центру
        main_layout = QVBoxLayout(central_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        # Меню
        menu_bar = self.menuBar()
        self.manager_menu = menu_bar.addMenu("Manager" if not translator else "")
        self.back_action = QAction("Back" if not translator else "", self)
        self.back_action.triggered.connect(self.open_main_window)
        self.manager_menu.addAction(self.back_action)

        # Заголовок
        self.title_label = QLabel("Конец смены" if not translator else "")
        self.title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        font = QFont()
        font.setPointSize(24)
        font.setBold(True)
        self.title_label.setFont(font)
        main_layout.addWidget(self.title_label)

        # Добавляем отступ
        main_layout.addSpacing(50)

        # Группа для полей ввода по центру
        self.input_group = QGroupBox("Введите суммы" if not translator else "")
        self.input_group.setFixedSize(500, 300)
        input_layout = QVBoxLayout()
        input_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        # Поле для наличных
        cash_layout = QHBoxLayout()
        self.cash_label = QLabel("Наличные:" if not translator else "")
        self.cash_label.setFixedWidth(120)
        self.cash_label.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.cash_input = QLineEdit()
        self.cash_input.setPlaceholderText("Введите сумму наличных" if not translator else "")
        self.cash_input.setFixedSize(200, 30)
        cash_layout.addWidget(self.cash_label)
        cash_layout.addWidget(self.cash_input)
        cash_layout.addStretch()
        input_layout.addLayout(cash_layout)

        # Добавляем отступ между полями
        input_layout.addSpacing(20)

        # Поле для карты
        card_layout = QHBoxLayout()
        self.card_label = QLabel("Карта:" if not translator else "")
        self.card_label.setFixedWidth(120)
        self.card_label.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.card_input = QLineEdit()
        self.card_input.setPlaceholderText("Введите сумму по карте" if not translator else "")
        self.card_input.setFixedSize(200, 30)
        card_layout.addWidget(self.card_label)
        card_layout.addWidget(self.card_input)
        card_layout.addStretch()
        input_layout.addLayout(card_layout)

        # Добавляем отступ между полями
        input_layout.addSpacing(20)

        # Поле для остатка
        balance_layout = QHBoxLayout()
        self.balance_label = QLabel("Остаток:" if not translator else "")
        self.balance_label.setFixedWidth(120)
        self.balance_label.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.balance_input = QLineEdit()
        self.balance_input.setPlaceholderText("Введите остаток" if not translator else "")
        self.balance_input.setFixedSize(200, 30)
        balance_layout.addWidget(self.balance_label)
        balance_layout.addWidget(self.balance_input)
        balance_layout.addStretch()
        input_layout.addLayout(balance_layout)

        # Добавляем отступ перед кнопкой
        input_layout.addSpacing(40)

        # Кнопка подтверждения по центру
        button_layout = QHBoxLayout()
        button_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.confirm_button = QPushButton("Подтвердить" if not translator else "")
        self.confirm_button.setFixedSize(150, 40)
        self.confirm_button.clicked.connect(self.confirm_shift_end)
        button_layout.addWidget(self.confirm_button)
        input_layout.addLayout(button_layout)

        self.input_group.setLayout(input_layout)

        # Центрируем группу в основном layout
        group_layout = QHBoxLayout()
        group_layout.addStretch()
        group_layout.addWidget(self.input_group)
        group_layout.addStretch()

        main_layout.addLayout(group_layout)

        if translator:
            self.retranslate_ui()

    def retranslate_ui(self):
        if not self.translator:
            return
        tr = self.translator.tr
        self.setWindowTitle(f"{tr('app_title')} - {tr('shift_report')}")
        self.manager_menu.setTitle(tr("manager"))
        self.back_action.setText(tr("back"))
        self.title_label.setText(tr("shift_end_title"))
        self.input_group.setTitle(tr("enter_amounts"))
        self.cash_label.setText(tr("cash"))
        self.cash_input.setPlaceholderText(tr("enter_amounts"))
        self.card_label.setText(tr("card"))
        self.card_input.setPlaceholderText(tr("enter_amounts"))
        self.balance_label.setText(tr("balance"))
        self.balance_input.setPlaceholderText(tr("enter_amounts"))
        self.confirm_button.setText(tr("confirm"))

    def confirm_shift_end(self):
        cash = self.cash_input.text()
        card = self.card_input.text()
        balance = self.balance_input.text()

        # Локализованные сообщения
        error_title = "Ошибка"
        please_fill = "Пожалуйста, заполните все поля!"
        valid_numbers = "Пожалуйста, введите корректные числовые значения!"
        positive_values = "Значения должны быть положительными и больше нуля!"
        success_title = "Успех"
        success_msg = "Смена завершена!"

        if self.translator:
            tr = self.translator.tr
            error_title = tr("error")
            please_fill = tr("please_fill_all")
            valid_numbers = tr("enter_valid_numbers")
            positive_values = tr("values_positive")
            success_title = tr("shift_completed")
            success_msg = tr("shift_completed")

        # Проверка, что все поля заполнены
        if not cash or not card or not balance:
            QMessageBox.warning(self, error_title, please_fill)
            return

        # Проверка, что введены числа
        try:
            cash_value = float(cash)
            card_value = float(card)
            balance_value = float(balance)
        except ValueError:
            QMessageBox.warning(self, error_title, valid_numbers)
            return

        # Проверка на положительные значения
        if cash_value <= 0 or card_value <= 0 or balance_value <= 0:
            QMessageBox.warning(self, error_title, positive_values)
            return

        # Здесь можно добавить логику обработки данных
        cash_text = "Наличные" if not self.translator else self.translator.tr("cash_amount")
        card_text = "Карта" if not self.translator else self.translator.tr("card_amount")
        balance_text = "Остаток" if not self.translator else self.translator.tr("balance_amount")
        
        QMessageBox.information(self, success_title,
                                f"{success_msg}!\n"
                                f"{cash_text}: {cash_value:.2f}\n"
                                f"{card_text}: {card_value:.2f}\n"
                                f"{balance_text}: {balance_value:.2f}")

    def open_main_window(self):
        self.main_window = MainWindow(self.translator)
        self.main_window.show_maximized()
        self.close()


class Settings(BaseWindow):
    def __init__(self, translator=None):
        super().__init__(translator)
        self.translator = translator
        
        self.setWindowTitle("ANK Software")
        self.settings = QSettings("ANK Software")
        self.current_theme = self.settings.value("theme", "light")
        self.current_style = self.settings.value("style", "Windows")

        self.apply_theme_and_style(self.current_theme, self.current_style)

        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        main_layout = QVBoxLayout(central_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)

        menu_bar = self.menuBar()
        self.tools_menu = menu_bar.addMenu("Tools" if not translator else "")
        self.back_action = QAction("Back" if not translator else "", self)
        self.back_action.triggered.connect(self.open_main_window)
        self.tools_menu.addAction(self.back_action)

        self.title_label = QLabel("Settings")
        self.title_label.setAlignment(Qt.AlignmentFlag.AlignLeft)
        font = QFont()
        font.setPointSize(18)
        self.title_label.setFont(font)
        main_layout.addWidget(self.title_label)

        # Группа для выбора языка (только если есть переводчик)
        if translator:
            self.language_group = QGroupBox("Language" if not translator else "")
            self.language_group.setFixedSize(300, 100)
            language_layout = QVBoxLayout()
            
            self.language_label = QLabel("Language:" if not translator else "")
            self.language_combo = QComboBox()
            self.language_combo.addItem("English", "en")
            self.language_combo.addItem("Русский", "ru")
            
            # Устанавливаем текущий язык
            current_index = self.language_combo.findData(self.translator.current_language)
            if current_index >= 0:
                self.language_combo.setCurrentIndex(current_index)
                
            self.language_combo.currentIndexChanged.connect(self.change_language)
            
            language_layout.addWidget(self.language_label)
            language_layout.addWidget(self.language_combo)
            self.language_group.setLayout(language_layout)
            main_layout.addWidget(self.language_group)

        self.color_theme_label = QLabel("Light/Dark themes")
        self.color_theme_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        font = QFont()
        font.setPointSize(14)
        self.color_theme_label.setFont(font)
        main_layout.addWidget(self.color_theme_label)

        self.theme_group = QGroupBox()
        self.theme_group.setFixedSize(250, 80)
        theme_layout = QVBoxLayout()

        self.light_theme_btn = QPushButton("Light theme")
        self.dark_theme_btn = QPushButton("Dark theme")

        self.light_theme_btn.clicked.connect(lambda: self.change_color_theme("light"))
        self.dark_theme_btn.clicked.connect(lambda: self.change_color_theme("dark"))

        theme_layout.addWidget(self.light_theme_btn)
        self.light_theme_btn.setFixedSize(225, 20)
        theme_layout.addWidget(self.dark_theme_btn)
        self.dark_theme_btn.setFixedSize(225, 20)
        self.theme_group.setLayout(theme_layout)

        main_layout.addWidget(self.theme_group)

        self.style_label = QLabel("Style themes")
        self.style_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        font = QFont()
        font.setPointSize(14)
        self.style_label.setFont(font)
        main_layout.addWidget(self.style_label)

        self.style_combo = QComboBox()
        self.style_combo.addItems(['Fusion', 'Windows'])
        self.style_combo.setCurrentText(self.current_style)
        self.style_combo.setFixedSize(250, 30)
        main_layout.addWidget(self.style_combo)

        self.apply_btn = QPushButton('Confirm Style')
        self.apply_btn.setFixedSize(250, 25)
        main_layout.addWidget(self.apply_btn)

        self.apply_btn.clicked.connect(self.change_style)

        if translator:
            self.retranslate_ui()

    def change_language(self, index):
        """Смена языка"""
        if index >= 0 and self.translator:
            lang_code = self.language_combo.itemData(index)
            if lang_code and lang_code != self.translator.current_language:
                success = self.translator.load_language(lang_code)
                if success:
                    print("Язык успешно изменен!")

    def change_color_theme(self, theme):
        self.current_theme = theme
        self.settings.setValue("theme", theme)
        self.apply_theme_and_style(theme, self.current_style)

    def change_style(self):
        style = self.style_combo.currentText()
        self.current_style = style
        self.settings.setValue("style", style)
        self.apply_theme_and_style(self.current_theme, style)

    def retranslate_ui(self):
        if not self.translator:
            return
        tr = self.translator.tr
        self.setWindowTitle(tr("app_title"))
        self.tools_menu.setTitle(tr("tools"))
        self.back_action.setText(tr("back"))
        self.title_label.setText(tr("settings"))
        
        if hasattr(self, 'language_group'):
            self.language_group.setTitle(tr("language"))
            self.language_label.setText(tr("language") + ":")
            
        self.color_theme_label.setText(tr("theme"))
        self.theme_group.setTitle(tr("theme"))
        self.light_theme_btn.setText(tr("light_theme"))
        self.dark_theme_btn.setText(tr("dark_theme"))
        self.style_label.setText(tr("style_themes"))
        self.apply_btn.setText(tr("confirm_style"))

    def open_main_window(self):
        self.main_window = MainWindow(self.translator)
        self.main_window.show_maximized()
        self.close()


# Функция для создания языковых файлов
def create_language_files():
    """Создает или перезаписывает языковые файлы"""
    if not os.path.exists('languages'):
        os.makedirs('languages')

    languages = {
        'en.txt': """app_title = ANK Software
autorization = Autorization
login = Login
password = Password
login_button = Login
error = Error
wrong_credentials = Wrong login, or password!
manager = Manager
shift_report = Shift report
exit = Exit
tools = Tools
settings = Settings
help = Help
user_guide = User Guide
about = About
support = Support
back = Back
shift_end_title = End of Shift
enter_amounts = Enter amounts
cash = Cash:
card = Card:
balance = Balance:
confirm = Confirm
please_fill_all = Please fill all fields!
enter_valid_numbers = Please enter valid numeric values!
values_positive = Values must be positive and greater than zero!
shift_completed = Shift completed!
cash_amount = Cash
card_amount = Card
balance_amount = Balance
light_theme = Light theme
dark_theme = Dark theme
language = Language
theme = Theme
style_themes = Style themes
confirm_style = Confirm Style""",

        'ru.txt': """app_title = ANK Software
autorization = Авторизация
login = Логин
password = Пароль
login_button = Войти
error = Ошибка
wrong_credentials = Неправильный логин или пароль!
manager = Менеджер
shift_report = Отчет о смене
exit = Выход
tools = Инструменты
settings = Настройки
help = Помощь
user_guide = Руководство пользователя
about = О программе
support = Поддержка
back = Назад
shift_end_title = Конец смены
enter_amounts = Введите суммы
cash = Наличные:
card = Карта:
balance = Остаток:
confirm = Подтвердить
please_fill_all = Пожалуйста, заполните все поля!
enter_valid_numbers = Пожалуйста, введите корректные числовые значения!
values_positive = Значения должны быть положительными и больше нуля!
shift_completed = Смена завершена!
cash_amount = Наличные
card_amount = Карта
balance_amount = Остаток
light_theme = Светлая тема
dark_theme = Темная тема
language = Язык
theme = Тема
style_themes = Стили интерфейса
confirm_style = Подтвердить стиль"""
    }

    for filename, content in languages.items():
        with open(f'languages/{filename}', 'w', encoding='utf-8') as f:
            f.write(content)


if __name__ == "__main__":
    # Создаем языковые файлы
    create_language_files()
    
    app = QApplication(sys.argv)
    
    # Загружаем настройки
    settings = QSettings("ANK Software")
    initial_style = settings.value("style", "Fusion")
    app.setStyle(initial_style)
    
    # Создаем переводчик
    translator = SimpleTranslator()
    
    # Запускаем приложение
    window = Autorization(translator)
    window.show_maximized()

    sys.exit(app.exec())
